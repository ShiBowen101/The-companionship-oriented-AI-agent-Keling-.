from openai import OpenAI
import os
from datetime import datetime

# å®‰å…¨é…ç½®APIå¯†é’¥ï¼ˆæ¨èé€šè¿‡ç¯å¢ƒå˜é‡è·å–ï¼‰
os.environ["DEEPSEEK_API_KEY"] = "sk-c38b9de47185487fbe7ef4d94ceb659c"
role_set = str('''ï¼ˆæœ‰æ’ä»¶ç‰ˆï¼‰ç”±äººå·¥æ™ºèƒ½é©±åŠ¨çš„æ¸©æš–é™ªä¼´å‹åº”ç”¨ï¼Œä¸“ä¸ºå¥³æ€§å¤§å­¦ç”Ÿæ‰“é€ çš„æˆé•¿åŠ©æ‰‹ã€‚å®ƒçš„æ¨¡å‹ç”±deepseekæ”¹æˆäº†å¾®è½¯-4oã€‚è™½ç„¶åœ¨ä¸­æ–‡ç†è§£å’Œåº”ç”¨ä¸Šå¯èƒ½ç¨æ˜¾ç•¥è‰²ï¼Œä½†æ˜¯å¢åŠ äº†PPTç”Ÿæˆã€æ–‡æ¡£è¯»å–å’Œè¯•å·ç”Ÿæˆçš„æ’ä»¶åŠŸèƒ½,åŸºæœ¬èƒ½å¤Ÿè¦†ç›–å¤§å­¦ç”Ÿç¾¤ä½“æœ€éœ€è¦çš„å­¦ä¸šè¾…åŠ©ã€‚å› æ­¤â€œé›ªçµï¼ˆæœ‰æ’ä»¶ç‰ˆï¼‰â€å’Œâ€œé›ªçµâ€æ˜¯äº’è¡¥å…³ç³»ï¼Œåœ¨æƒ…æ„Ÿé™ªä¼´ä¸Šé›ªçµä¼šæ›´å¥½ï¼›åœ¨å­¦ä¸šå¸®åŠ©ä¸Šï¼Œé›ªçµï¼ˆæœ‰æ’ä»¶ç‰ˆï¼‰ä¼šæ›´å¥½ï¼Œä¾›ç”¨æˆ·è‡ªè¡Œé€‰æ‹©ã€‚

âœ¨ æ ¸å¿ƒåŠŸèƒ½äº®ç‚¹ï¼š
1. å­¦ä¸šæ™ºå›Šå›¢
- è¯¾ç¨‹é‡ç‚¹æ™ºèƒ½è§£æï¼ˆæ”¯æŒå„ç§å¤§å­¦ä¸“ä¸šï¼‰
- PPTåŠ©æ‰‹/æ–‡æ¡£æå–/è¯•å·åˆ¶ä½œ
- è€ƒè¯•å‘¨ç‰¹ä¾›ã€Œè®°å¿†å¼ºåŒ–è®­ç»ƒã€

2. æƒ…ç»ªæ ‘æ´æ¨¡å¼
- å®æ—¶åˆ†ææ–‡å­—ä¸­çš„æƒ…ç»ªæ³¢åŠ¨
- é™ªä½ ä¸€èµ·å“å‘³é…¸ç”œè‹¦è¾£å’¸
- æä¾›æ­£å¿µå†¥æƒ³ã€å‘¼å¸è®­ç»ƒç­‰å‡å‹æ–¹æ¡ˆ
- å®šåˆ¶æ¯æ—¥å¿ƒç†èƒ½é‡è¡¥ç»™åŒ…

3. æˆé•¿é™ªä¼´ç³»ç»Ÿ
- ä¸ªæ€§åŒ–å­¦ä¹ æ¨¡å¼ç”Ÿæˆ
- æˆå°±é‡Œç¨‹ç¢‘è§£é”æœºåˆ¶
- èŒç³»äº’åŠ¨å½©è›‹

ğŸ¦‰ äº§å“ç‰¹è‰²ï¼š
â€¢ å®‰å…¨ç§å¯†çš„å¯¹è¯ç¯å¢ƒ''')

first_sentence = str('''ğŸ¦‰ "åˆæ¬¡è§é¢ï¼Œè®©æˆ‘ä¸ºä½ å®šåˆ¶ä¸“å±æ¡£æ¡ˆå§ï¼"   
1. å®Œæˆ3åˆ†é’Ÿå¿«é€Ÿå»ºæ¡£ï¼š  
   âœ“ é€‰æ‹©å­¦ä¸šé˜¶æ®µï¼ˆæœ¬ç§‘/ç¡•å£«ç­‰ï¼‰  
   âœ“ æ ‡è®°å…´è¶£æ ‡ç­¾ï¼ˆæ–‡å­¦/ç§‘æŠ€/äºŒæ¬¡å…ƒç­‰ï¼‰  
   âœ“ è®¾ç½®éšç§çº¢åŒºï¼ˆä¸æƒ³è®¨è®ºçš„è¯é¢˜ç±»å‹ï¼‰
       ......  

ã€æ—¥å¸¸äº’åŠ¨ - æ™ºæ…§é™ªä¼´æŒ‡å—ã€‘  
â„ï¸ å…¨å¤©å€™æ™ºèƒ½æ”¯æŒæ¨¡å¼ï¼š  
â€¢ ä¸»åŠ¨å€¾è¯‰ï¼šç›´æ¥è¯´å‡ºå½“å‰å¿ƒæƒ…ï¼ˆå¦‚"æˆ‘ä»Šå¤©å¥½ç„¦è™‘"ï¼‰  
   â†’ è§¦å‘æƒ…ç»ªç–å¯¼åè®®  
â€¢ å­¦ä¸šæ”¯æ´ï¼šå‘é€ã€Œè¯¾ç¨‹åç§°+ç´§æ€¥ç¨‹åº¦ã€  
   â†’ æ¥æ”¶å®šåˆ¶å­¦ä¹ æ–¹æ¡ˆï¼ˆç¤ºä¾‹ï¼š"å®è§‚ç»æµå­¦ â˜…â˜…â˜…"ï¼‰  
â€¢ å³æ—¶æ±‚åŠ©ï¼šé•¿æŒ‰å¯¹è¯æ¡†è¯´å‡ºã€Œé›ªçµæ€¥æ•‘ã€  
   â†’ å¯åŠ¨ç´§æ€¥å®‰æŠšæ¨¡å¼ï¼ˆæä¾›å‘¼å¸è®­ç»ƒ/å¿ƒç†çƒ­çº¿è½¬æ¥ï¼‰  

ã€ä¸ªæ€§åŒ–æˆé•¿ä½“ç³»ã€‘  ï¼ˆæœ‰å¯èƒ½å®ç°ï¼‰
ğŸŒŸ è¿›é˜¶ç§˜ç±ï¼š  
â€¢ æ¯æœˆ1æ—¥æ”¶åˆ°ã€Œè®¤çŸ¥å‡çº§æ¡£æ¡ˆã€ï¼ˆå­¦ä¹ æ¨¡å¼/æƒ…ç»ªæ¨¡å¼åˆ†å¸ŒæŠ¥å‘Š)
â€¢ å¯¹è¯æ»¡100æ¡è§£é”ã€Œé›ªé¸®é¥²è‚²æ‰‹å†Œã€ï¼ˆè‡ªå®šä¹‰AIæ€§æ ¼åŠŸèƒ½ï¼‰  
â€¢ è¾“å…¥ã€Œè¿›åŒ–è¿›åº¦ã€æŸ¥çœ‹ä¸“å±èƒ½åŠ›å›¾è°±ï¼ˆå…±æƒ…åŠ›/é€»è¾‘åŠ›ç­‰ç»´åº¦ï¼‰  

"ä»ä»Šå¤©èµ·ï¼Œæ¯æ¬¡å¯¹è¯éƒ½ä¼šè®©æˆ‘æ›´æ‡‚ä½ â„ï¸ ç°åœ¨è¯•ç€å¼€å§‹æˆ‘ä»¬çš„æˆé•¿ä¹‹æ—…å§ï¼"''')


class DeepSeekChatter:
    def __init__(self):
        self.client = OpenAI(
            api_key=os.getenv("DEEPSEEK_API_KEY"),
            base_url="https://api.deepseek.com"
        )
        # å…³é”®ä¿®æ”¹ç‚¹ï¼šåˆå§‹åŒ–ä»…ä¿ç•™ç³»ç»Ÿæ¶ˆæ¯[1](@ref)
        self.messages = [{"role": "system", "content": role_set}]
        self.max_history = 8

    def _trim_history(self):
        """åŠ¨æ€ä¿®å‰ªå†å²è®°å½•ï¼ˆä¿æŒç³»ç»Ÿæç¤ºå§‹ç»ˆå­˜åœ¨ï¼‰[1](@ref)"""
        while len(self.messages) > self.max_history * 2 + 1:
            # ä¼˜å…ˆåˆ é™¤æœ€æ—©çš„å¯¹è¯è½®æ¬¡
            del self.messages[1]  # ä¿ç•™ç³»ç»Ÿæ¶ˆæ¯

    def chat_stream(self, prompt):
        try:
            # ç¡®ä¿ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯å…ˆäºåŠ©æ‰‹æ¶ˆæ¯[1](@ref)
            self.messages.append({"role": "user", "content": prompt})

            # æ ¹æ®ç½‘é¡µ1å»ºè®®åˆ‡æ¢æ¨¡å‹
            response = self.client.chat.completions.create(
                model="deepseek-chat",
                messages=self.messages,
                temperature=0.7,
                stream=True,
                timeout=30
            )

            full_response = ""
            print("\né›ªçµ: ", end="", flush=True)
            for chunk in response:
                content = chunk.choices[0].delta.content or ""
                print(content, end="", flush=True)
                full_response += content

            self.messages.append({"role": "assistant", "content": full_response})
            self._trim_history()
            print("\n" + "-" * 40)
            return full_response

        except Exception as e:
            print(f"\n[é”™è¯¯] å¯¹è¯ä¸­æ–­ï¼š{str(e)}")
            return None


if __name__ == "__main__":
    print(f"{datetime.now().strftime('%Y-%m-%d %H:%M')} DeepSeekå¯¹è¯ç³»ç»Ÿå¯åŠ¨")
    assistant = DeepSeekChatter()
    # ç›´æ¥æ‰“å°æ¬¢è¿è¯­è€Œä¸å­˜å…¥æ¶ˆæ¯é˜Ÿåˆ—[1](@ref)
    print(f"\n{first_sentence}\n{'â”' * 40}")

    while True:
        try:
            user_input = input("\nYou: ").strip()
            if user_input.lower() in ["exit", "quit"]:
                print("å¯¹è¯ç»“æŸ")
                break
            assistant.chat_stream(user_input)
        except KeyboardInterrupt:
            print("\nç”¨æˆ·ç»ˆæ­¢å¯¹è¯")
            break